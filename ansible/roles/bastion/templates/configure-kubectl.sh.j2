#!/bin/bash
# Configure kubectl for EKS cluster access
# Generated by Ansible for {{ cluster_name }}

set -e

CLUSTER_NAME="{{ cluster_name }}"
REGION="{{ region }}"

echo "================================================"
echo "üîß Configuring kubectl for EKS cluster"
echo "================================================"
echo "Cluster: $CLUSTER_NAME"
echo "Region: $REGION"
echo ""

# Check if AWS CLI is configured
echo "Checking AWS configuration..."
if ! aws sts get-caller-identity >/dev/null 2>&1; then
    echo "‚ùå AWS CLI is not configured or credentials are invalid"
    echo "Please configure AWS credentials first:"
    echo "  aws configure"
    echo "  OR"
    echo "  export AWS_ACCESS_KEY_ID=your_key"
    echo "  export AWS_SECRET_ACCESS_KEY=your_secret"
    echo "  export AWS_DEFAULT_REGION=$REGION"
    exit 1
fi

echo "‚úÖ AWS credentials are valid"
aws sts get-caller-identity

echo ""
echo "Updating kubeconfig for cluster: $CLUSTER_NAME"

# Update kubeconfig
if aws eks update-kubeconfig --region $REGION --name $CLUSTER_NAME; then
    echo "‚úÖ kubectl configured successfully"
else
    echo "‚ùå Failed to configure kubectl"
    echo "Please check:"
    echo "  1. Cluster name is correct: $CLUSTER_NAME"
    echo "  2. Region is correct: $REGION"
    echo "  3. You have permission to access the cluster"
    exit 1
fi

echo ""
echo "Testing cluster connectivity..."

# Test kubectl connectivity
if kubectl get nodes >/dev/null 2>&1; then
    echo "‚úÖ Cluster connectivity test passed"
    echo ""
    echo "Cluster Information:"
    echo "==================="
    kubectl get nodes
    echo ""
    echo "Available namespaces:"
    kubectl get namespaces
else
    echo "‚ùå Cannot connect to cluster"
    echo "Please check cluster status and your permissions"
    exit 1
fi

echo ""
echo "================================================"
echo "‚úÖ kubectl configuration complete!"
echo "================================================"
echo ""
echo "Quick commands to try:"
echo "  kubectl get nodes"
echo "  kubectl get pods --all-namespaces"
echo "  kubectl get services --all-namespaces"
echo "  helm list --all-namespaces"
echo ""
echo "Helpful aliases available:"
echo "  k = kubectl"
echo "  kgp = kubectl get pods"
echo "  kgs = kubectl get services"
echo "  kgn = kubectl get nodes"
echo ""
